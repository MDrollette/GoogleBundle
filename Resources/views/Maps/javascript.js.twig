{% spaceless %}
    var maps = maps || {};

    maps["{{ map_id }}"] = { 
        currentWindow: null,
        options: null,
        map: null,
        coordinates: null,
        markers: null,
        infowindows: null,
        bounds: null,
        clickMarker: null,
        clickCallback: null
    };


    maps["{{ map_id }}"].options = {
        zoom: {{ zoom }}, 
        center: new google.maps.LatLng( {{ latitude }}, {{ longitude }} ), 
        MapTypeId: google.maps.MapTypeId.{{ type }}
    }

    maps["{{ map_id }}"].map = new google.maps.Map(document.getElementById("{{ map_id }}"), maps["{{ map_id }}"].options);
    
    {% if map.hasMarkers %}
        {# Markers coordinates #}
        maps["{{ map_id }}"].coordinates = [
        {% for marker in map.getMarkers %}
            new google.maps.LatLng( {{ marker.getLatitude }}, {{ marker.getLongitude }} )
            {% if not loop.last %}
                ,
            {% endif %}
        {% endfor %}
        ];

        {# Markers objects #}
        maps["{{ map_id }}"].markers = [
        {% for marker in map.getMarkers %}
            new google.maps.Marker({ 
                position: new google.maps.LatLng( {{ marker.getLatitude }}, {{ marker.getLongitude }} ),
                map: maps["{{ map_id }}"].map,
                title: ''
            })
            {% if not loop.last %}
                ,
            {% endif %}
        {% endfor %}
        ];

        {# Infowindows #}
        maps["{{ map_id }}"].infowindows = [
        {% for marker in map.getMarkers %}
            new google.maps.InfoWindow({ content: "{{ marker.getMeta.infowindow | raw }}" })
            {% if not loop.last %}
                ,
            {% endif %}
        {% endfor %}
        ];

        {# Event listeners for infowindows #}
        {% for key in map.getMarkers|keys %}
            google.maps.event.addListener(maps["{{ map_id }}"].markers[{{ key }}], "click", function () {
                    if (maps["{{ map_id }}"].currentWindow) {
                        maps["{{ map_id }}"].currentWindow.close();
                    }
                    maps["{{ map_id }}"].infowindows[{{ key }}].open(maps["{{ map_id }}"].map, maps["{{ map_id }}"].markers[{{ key }}]);
                    maps["{{ map_id }}"].currentWindow = maps["{{ map_id }}"].infowindows[{{ key }}];
            });
        {% endfor %}

        {# fit to markers #}
        maps["{{ map_id }}"].bounds = new google.maps.LatLngBounds();
        for (index in maps["{{ map_id }}"].coordinates) {
            maps["{{ map_id }}"].bounds.extend(maps["{{ map_id }}"].coordinates[index]);
        }
        maps["{{ map_id }}"].map.fitBounds(maps["{{ map_id }}"].bounds);
    {% endif %}
    
    {# Clickable #}
    {% if callback is not empty %}
        maps["{{ map_id }}"].clickMarker;
        maps["{{ map_id }}"].clickCallback = {{ callback }};
        google.maps.event.addListener(maps["{{ map_id }}"].map, "click", function(event) {  
            if (maps["{{ map_id }}"].clickMarker) {
                maps["{{ map_id }}"].clickMarker.setMap(null);
                maps["{{ map_id }}"].clickMarker = null;
            }
            maps["{{ map_id }}"].clickCallback(event.latLng);
            maps["{{ map_id }}"].clickMarker = new google.maps.Marker({
                position: event.latLng,
                map: maps["{{ map_id }}"].map,
                zIndex: Math.round(event.latLng.lat()*-100000)<<5
            });
        });
    {% endif %}
{% endspaceless %}

